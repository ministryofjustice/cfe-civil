[![CircleCI](https://circleci.com/gh/ministryofjustice/cfe-civil.svg?style=shield)](https://circleci.com/gh/ministryofjustice/cfe-civil/tree/main)
[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=for-the-badge&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Fcfe-civil&logo=data:image/png;base64,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)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-github-repositories.html#cfe-civil)

# Check Financial Eligibility - Civil (CFE-Civil)

An API that does the "civil means test" calculations i.e. whether someone's financial position makes them eligible for legal aid, for civil cases.

## Scope

CFE-Civil is suitable for:

* All case types, including certificated, controlled, asylum & immigration
* SMOD - where assets are disputed between the parties
* Partner - where the client has a partner, whose finances are included in the assessment

Not (yet) suitable for:

* Special applicant groups:
  * Self Employed: Sole Trader applicants
  * Self Employed: Sub-contractor applicants
  * Self Employed: Applicants in a Business Partnership
  * Self Employed: Shareholders in PLC/Company Directors
  * Applicants under 18 in Family cases 
  * Applicants under 18 in Non-Family cases
  * Police officer applicants
  * Prisoner applicants
  * Applicants living outside of the UK
  * Applicants in the HM Forces
  * Applicants who are Insolvent
  * Applicants who are Bankrupt
  * Applicants subject to a freezing order 

## Unforking

This repo [CFE-Civil](https://github.com/ministryofjustice/cfe-civil) is a "merge" of CCQ's "fork" [CFE-Partner](https://github.com/ministryofjustice/check-financial-eligibility-partner/) and Civil Apply's original [CFE](https://github.com/ministryofjustice/check-financial-eligibility). We have moved CCQ over to using CFE-Civil now, and are currently working to ensure CFE-Civil is also compatible with Civil Apply, so that both are using CFE-Civil.

CFE-Civil has enhancements over the original CFE:

* partner functionality added - to include in the calculation the financial info about the client's partner
* v6 API ("one shot API") added

# API Usage

## API Documentation

API documentation is available as:

* as a Swagger page on the running service, at `<hostname>/api-docs/index.html`
* as a Swagger definition in this repo: swagger/v5/swagger.yaml

## API Versioning

The API version in the URL path:

* v5 API - path contains no version number e.g. `/assessments/{assessment_id}/applicant`
* v6 API - path `/v6/assessments`

## API Changelog

### 2023-04-03 v6 "one shot API"

See design reasoning: [ADR12 One Shot API](https://dsdmoj.atlassian.net/wiki/spaces/EPT/pages/4405395614/ADR12+One+shot+API)
### 2022-07-12 v5

This was the last release of the API by the Civil Apply team.

There were previous releases, but they have since been removed from the code base.
#### v5 usage

The client will create an assessment by posting a payload to the `/assessments` endpoint, which will respond with an `assessment_id`.  This assessment id
is then given on all subsequent posts to the other endpoints to build up a record of capital, income and outgoings, finally requesting an assessment result
by sending a GET request to the /assessments endpoint.

**TODO** When in future this API has endpoints to allow direct submission of monthly income and outgoings figures (rather than collections of transactions from which these figures are inferred), make clear in the documentation for those endpoints that for controlled work that the API client should only submit figures that are valid for the calendar month leading up to the submission date, not an average of the previous 3 months.

# System architecture

See more about the architecture, including Architecture Decision Records in the team Confluence: <https://dsdmoj.atlassian.net/wiki/spaces/EPT/pages/4317577492/Technical+Architecture>

## Architecture diagrams

Architecture diagrams can be viewed here: <https://dsdmoj.atlassian.net/wiki/spaces/EPT/pages/4377182543/Architecture+Diagrams>

## Data model

The database/ORM structure:

* [ORM diagram](https://dsdmoj.atlassian.net/wiki/spaces/EPT/pages/4377182543/Architecture+Diagrams#ORM-diagram)
* [Database model](https://dsdmoj.atlassian.net/wiki/spaces/EPT/pages/4377182543/Architecture+Diagrams#Database-model)

Mostly the database objects contain a record of the input data. There are also some that hold thresholds and some calculation outputs, but we're aiming to elimenate them - see [ADR05 Remove from database the calculation results and instead return them as objects from calculation functions](https://dsdmoj.atlassian.net/wiki/spaces/EPT/pages/4377542797/ADR05+Remove+from+database+the+calculation+results+and+instead+return+them+as+objects+from+calculation+functions)

The (main) assessment is determined by using three (sub) assessments. Those three assessments, with their corresponding parent object are:

* gross income assessment - `GrossIncomeSummary`
* disposable income assessment - `DisposableIncomeSummary`
* capital assessment - `CapitalSummary`

(Previously these 'summary' objects held properties containing sub-totals and results of each (sub) assessment, but now they don't. Instead the sub-totals and results are simply passed to the output decorators.)

Attached to each summary object are the input data, represented as one or more sub-objects, representing the individual items/transactions: the `GrossIncomeSummary` has income of various types, `CapitalSummary` has capital items, and the `DisposableIncomeSummary` various outgoings.

Each of the three summary objects also has a number of "Eligibility" objects - one for each proceeding type specified on the assessment.  Each eligibility object contains the upper and lower thresholds for that proceeding type, and will eventually hold the result for that proceeding type.


## Logic flow of the calculations

The `AssessmentController` calls the `MainWorkflow`, which immediately branches off to the `PassportedWorkflow` or `UnpassportedWorkflow`.  The main difference is that unpassported applications are assessed on capital, gross income and disposable income, whereas passported applications are only assessed on capital.

In each case, the workflow takes each of the assessments in turn, calls a collator to look at all the sub-objects under the summary and come up with a total figure in the case of capital, or a monthly equivalent figure in the case of gross or disposable  income, and these results are stored on the associated summary object.  After collation, an assessor is called for each summary which stores the results (eligible, ineligible, contribution required) in each of the eligibility objects (one for each proceeding type).  Finally, the main assessor is called to work out the overall result for each proceeding type taking into account the results from the capital, gross income and disposable income assessments.  The assessments controller then calls the main decorator to format the output in the required structure to send back to the client.

# Development

## Setting the env vars

Developers need a `.env` file in the root folder of their clone of this repo.

For running locally it should contain the following values:

```sh
LEGAL_FRAMEWORK_API_HOST=https://legal-framework-api-staging.apps.live-1.cloud-platform.service.justice.gov.uk
```

(There used to be an option `ALLOW_FUTURE_SUBMISSION_DATE`, but now specifying a submission_date in the future is always allowed.)

However for running the integration tests, you need a few more values, including secrets - see: [Environment variables for Integration tests (spreadsheets)](#environment-variables-for-integration-tests-spreadsheets)

## Developer Setup

1.  Ensure Ruby is installed - for example using rbenv - with the version specified in `.ruby-version`

2.  Install these system dependencies:

    ```sh
    brew install shared-mime-info
    brew install cmake
    brew install postgresql
    # run postgres now AND on every boot
    brew services start postgresql
    ```

3.  Run the setup script:

    ```sh
    bin/setup
    ```

    This will:

    * install or update Ruby gem dependencies
    * ensure your local PostgreSQL has the development and test databases created, and runs any outstanding migrations

## Guard

It's recommended for devs to run 'Guard' in the background, to ensure RSwag rebuilds the swagger docs, and other tasks, before committing. This is more efficient than waiting for the CI to catch issues.

    Run Guard through Bundler with
    ```sh
    bundle exec guard
    ```

    Show configuration options for each used plugin
    ```sh
    bundle exec guard show
    ```

## Running the API locally

Start rails server:

```sh
bin/rails server
```

Try this simple test, to ensure it's working:

```
$ curl http://127.0.0.1:3000/healthcheck
{"checks":{"database":true}}
```
## Generation of API documentation using Rswag

See [Rswag readme](https://github.com/rswag/rswag/blob/master/README.md) for initial setup and/or modifications.

The `swagger` folder in the root directory has one `swagger.yaml` within a version number folder - e.g. `swagger/v4/swagger.yaml`. This file is what defines the swagger ui page displayed at `/api-docs`. This file is generated using rswag's rake task - `rake rswag:specs:swaggerize`.

The `swagger.yaml` file that is generated is defined by a combination of "global" settings in `spec/swagger_helper.rb` and indivual spec files that are, by our convention, stored in `spec/requests/swagger_docs/<version>/*.spec.rb`.

You can generate a new endpoint spec file using:
```sh
rails generate rspec:swagger MyController
```

You can update an existing endpoint by modifying it's spec and then running:
```sh
rake rswag:specs:swaggerize
```

## Threshold configuration files

**NB This is deprecated functionality** - instead we can put future thresholds into the YAML and access them by passing appropriate dates.

Files holding details of all thresholds values used in calculating eligibility are stored in `config/thresholds`.
The file `values.yml` details the start dates for each set of thresholds, and the name of the file from which they should be read.

If a file has the key `test_only` with a value of true, then that file will only be read if the
`USE_TEST_THRESHOLD_DATA` environment variable is set to true.  This is the default for staging and UAT, and it is
false for production.

This allows the insertion of test data on an arbitrary date specified in the `values.yml` file to be used
for testing new thresholds before they come into affect on production.

## Tests

CFE-Civil has several kinds of tests:

* End to End (E2E) tests
* Integration tests defined in Spreadsheets and using RSpec
* Integration tests using Cucumber
* Unit tests - using RSpec

For the purpose of each type of test, see: [CFE-Civil Test pyramid](https://docs.google.com/drawings/d/1XADSXrS-wQ6GHWo8b5JLdnWEHjrR_OyX5xT2uB4_jI4/edit)

### End to End (E2E) tests

The E2E tests perform user journeys using CCQ's web interface, using both CCQ and CFE-Civil running together. This helps us spot real-world incompitibilities between CCQ's requests and what CFE-Civil accepts.

The test cases are defined in the CCQ repo: https://github.com/ministryofjustice/laa-estimate-financial-eligibility-for-legal-aid/tree/main/spec/end_to_end

E2E tests are run by the [CircleCI config](.circleci/config.yml) - see the `end2end_tests` workflow.
### RSpec tests

The RSpec test suite in </spec> includes "Integration tests (spreadsheets)" and "other RSpec tests", but not "Integration tests (cucumber)" or E2E tests.

#### Environment variables for Integration tests (spreadsheets)

Before you can run the spreadsheet integration tests you will need to set up a `.env` file in the root folder of your clone of this repo.

Obtain the `.env` file from 1Password - look in the folder `LAA-Eligibility-Platform`, under item `Environment variables to run CFE ISPEC (spreadsheet) tests`. If you don't have access, see: [Tech we use - 1Password](https://dsdmoj.atlassian.net/wiki/spaces/EPT/pages/4323606529/Tech+we+use#1Password)

Environment variables:

| Name | Value examples & commentary |
| ---- | --------------------------- |
| GOOGLE_SHEETS_PRIVATE_KEY_ID | (secret) |
| GOOGLE_SHEETS_PRIVATE_KEY | (secret) |
| GOOGLE_SHEETS_CLIENT_EMAIL | (secret) |
| GOOGLE_SHEETS_CLIENT_ID | (secret) |
| RUNNING_AS_GITHUB_WORKFLOW | `TRUE` / `FALSE` |
| LEGAL_FRAMEWORK_API_HOST | `https://legal-framework-api-staging.apps.live-1.cloud-platform.service.justice.gov.uk` |

#### Running RSpec tests

The RSpec test suite in </spec> includes "Integration tests (spreadsheets)" and "other RSpec tests", but not "Integration tests (cucumber)" or E2E tests.

Run them with:

```sh
bundle exec rspec
```

`pry-rescue` allows you to run tests so that a `pry` prompt will be opened on test failure or unhandled exceptions, which can be helpful for debugging. It is a gem which is included in this repo. Run it with:

```sh
bundle exec rescue rspec
```

#### Common errors

Error:
```ruby
   An error occurred while loading ./spec/integration/policy_disregards_spec.rb.
   Failure/Error: require File.expand_path("../config/environment", __dir__)

   NoMethodError:
     undefined method `gsub' for nil:NilClass
```
Solution: fix your .env file. See: [Environment variables for Integration tests (spreadsheets)](#environment-variables-for-integration-tests-spreadsheets)

Error:
```ruby
   An error occurred while loading ./spec/validators/json_validator_spec.rb.
   Failure/Error: ActiveRecord::Migration.maintain_test_schema!

   ActiveRecord::NoDatabaseError:
     We could not find your database: cfe_civil_test. Which can be found in the database configuration file located at config/database.yml.
```
Solution: fix your database, which should have been created with `bin/setup` - see [Developer setup](developer-setup)

### Integration tests (spreadsheets)

A series of spreadsheets is used to provide use cases and their expected results, and are run as part of the normal `rspec` test suite, or can be run individually with more control using the script `bin/ispec` (see below).

The [Master CFE Integration Tests Spreadsheet](https://docs.google.com/spreadsheets/d/1lkRmiqi4KpoAIxzui3hTnHddsdWgN9VquEE_Cxjy9AM/edit#gid=651307264) lists all the other spreadsheets to be run, as well as contain skeleton worksheets for creating new tests scenarios.  Each spreadsheet can hold multiple worksheets, each of which is a test scenario.

You can run these tests, in the standard rspec way:

```sh
bundle exec rspec --pattern=spec/integration/test_runner_spec.rb -fd
```

Each worksheet is a test scenario, which is run as an rspec example.

For more fine control over the amount of verbosity, to run just one test case, or to force download the google spreadsheet,
use `bin/ispec`, the help text of which is given below.

```text
ispec - Run integration tests

options:
-h        Display this help text
-r        Force refresh of Google speadsheet to local storage
-v        Set verbosity level to 1 (default is 0: silent) - produce detailed expected and actual results
-vv       Set verbosity level to 2 - display all payloads, and actual and expected results
-w XXX    Only process worksheet named XXX
```

Each worksheet has an entry `Test Active` which can be either true or false.  If set to false, the worksheet will be skipped, unless it is
the named worksheet using the `-w` command line switch.

### Integration tests (cucumber)

We are [trialling the use of cucumber for integration tests](https://dsdmoj.atlassian.net/wiki/spaces/LE/pages/4229660824/Architectural+Design+Records#Cucumber-tests-trial-in-CFE-Partner), in particular to document features added for the "[CCQ](https://github.com/ministryofjustice/laa-estimate-financial-eligibility-for-legal-aid)" client. These cucumber tests are to be found in the `features` folder.

Run them with:

```sh
bundle exec cucumber
```

### Unit tests in RSpec

The aim is for these to be "unit test" style - i.e. numerous tests that cover the detail of the functionality - the bottom level of the [test pyramid](https://martinfowler.com/articles/practical-test-pyramid.html). See: [CFE-Civil Test pyramid](https://docs.google.com/drawings/d/1XADSXrS-wQ6GHWo8b5JLdnWEHjrR_OyX5xT2uB4_jI4/edit)

Run them with:

```sh
bundle exec rspec --exclude-pattern=spec/integration/test_runner_spec.rb
```

## Replaying live API interactions for debugging purposes

In the event that you need to investigate why a CFE result was produced on live, there is
a way to replay the API calls of the original application and debug the assessment process
on a local machine

1) Record the original api payloads and calls on the Apply system
   Run the rake task `rake cfe:record_payloads`.  This will print to the screen a YAML
   representation of the calls to the API with the actual payloads

2) Copy and paste that output to the file `tmp/api_payloads.yml` in this repo

3) Start a CFE server locally on port 4000, and add breakpoints at the required places

4) Run the rake task `rake replay`: this will read the `tmp/api_payloads.yml` file and
   replay the original API calls and payloads enabling you to re-create the conditions.


# Deployment

This app is deployed on Cloud Platform by CircleCI, using the Helm chart in deploy/helm. 

[CircleCI pipeline for cfe-civil](https://app.circleci.com/pipelines/github/ministryofjustice/cfe-civil)

## Kubernetes secrets

Secrets are sourced from 1Password and deployed into an environment/namespace by manually running `kubectl create secret` commands. See: https://dsdmoj.atlassian.net/wiki/spaces/EPT/pages/4356833911/Secrets

Within the `kube-secrets` k8s secret, the following keys are available:

* notifications-api-key
* sentry-dsn
* secret-key-base
* postgresql-postgres-password (for UAT only, as this environment has a pod running Postgres instead of an RDS instance)
