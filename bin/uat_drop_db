#!/bin/bash
# NOTE: uses current authentication, context and namespace but errors
# unless namespace ends with UAT.
#
# Assuming RDS secret name is the same this could
# work for other UAT namespaces.
#

function _uat_drop_db() {
  usage="uat_drop_db -- drop an rds instance with same name as that specified
  Usage: bin/uat_drop_db <uat-release-name>
  DANGER: This will use the current authentication, context and namespace but checks the
          the namespace ends with "-uat"
  Example:
    # drop postgres database connected to the UAT RDS instance with a name matching "my-uat-branch-name"
    bin/uat_drop_db my-uat-branch-name
    "

  # exit when any command fails, keep track of the last for output
  # https://intoli.com/blog/exit-on-errors-in-bash-scripts/
  set -e
  trap 'last_command=$current_command; current_command=$BASH_COMMAND' DEBUG
  trap 'echo "\"${last_command}\" command completed with exit code $?."' EXIT

  current_namespace=$(kubectl config view --minify --output 'jsonpath={..namespace}'; echo)
  if [[ ! $current_namespace =~ -uat$ ]]
  then
    echo "namespace must be UAT!" >&2
    return 1
  fi

  if [[ $# -ne 1 ]]; then
    echo "$usage"
    return 1
  else
    UAT_RELEASE=$1
  fi

  echo 'Retrieve RDS credentials'
  DB_HOST=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.rds_instance_address}" | base64 --decode)
  DB_NAME=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_name}" | base64 --decode)
  DB_USER=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_username}" | base64 --decode)
  DB_PWD=$(kubectl get secret rds-postgresql-instance-output -o jsonpath="{.data.database_password}" | base64 --decode)

  case "$1" in
    rdsadmin | template0 | template1 | postgres | main | $DB_NAME)
      echo "you should not drop the DB named \"$1\" ...aborting!" >&2
      return 1
      ;;
    *)
      ;;
  esac

  GET_QUERY="SELECT datname FROM pg_database WHERE datname = '${UAT_RELEASE}'"
  DATABASE_TO_DROP=$(psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -qtc "${GET_QUERY};" | xargs) # xargs trims the spaces around the psql output of names
  if [[ -z "${DATABASE_TO_DROP}" ]]; then
    echo "DATABASE NOT FOUND \"${UAT_RELEASE}\"!"
    break
  else
    echo "DATABASE FOUND \"${DATABASE_TO_DROP}\"!"
  fi
}

_uat_drop_db $@
